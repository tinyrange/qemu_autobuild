name: qemu_autobuild

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Set a variable to the version of QEMU to build
env:
  QEMU_VERSION: 9.2.1

jobs:
  build_macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install packages
        run: brew install ninja

      - name: Download QEMU
        run: |
          wget https://download.qemu.org/qemu-$QEMU_VERSION.tar.xz
          tar -xf qemu-$QEMU_VERSION.tar.xz
          mv qemu-$QEMU_VERSION qemu

      - name: Build QEMU
        run: |
          BUILD_DIR=$(pwd)
          mkdir $BUILD_DIR/dist

          cd qemu
          mkdir build
          cd build
          
          ../configure --target-list=aarch64-softmmu --without-default-features --enable-hvf --prefix=$BUILD_DIR/dist
          ninja
          ninja install

      - name: Archive binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-darwin-arm64
          path: |
            dist

  build_linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install packages
        run: sudo apt-get update && sudo apt-get install -y ninja-build libglib2.0-dev libpixman-1-dev

      - name: Download QEMU
        run: |
          wget https://download.qemu.org/qemu-$QEMU_VERSION.tar.xz
          tar -xf qemu-$QEMU_VERSION.tar.xz
          mv qemu-$QEMU_VERSION qemu

      - name: Build QEMU
        run: |
          BUILD_DIR=$(pwd)
          mkdir $BUILD_DIR/dist

          cd qemu
          mkdir build
          cd build
          
          ../configure --target-list=x86_64-softmmu --without-default-features --enable-kvm --static --prefix=$BUILD_DIR/dist
          ninja
          ninja install

      - name: Archive binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-linux-amd64
          path: |
            dist

  build_linux_arm64:
    runs-on: ubuntu-24.04-arm
    
    steps:
      - uses: actions/checkout@v3

      - name: Install packages
        run: sudo apt-get update && sudo apt-get install -y ninja-build libglib2.0-dev libpixman-1-dev

      - name: Download QEMU
        run: |
          wget https://download.qemu.org/qemu-$QEMU_VERSION.tar.xz
          tar -xf qemu-$QEMU_VERSION.tar.xz
          mv qemu-$QEMU_VERSION qemu

      - name: Build QEMU
        run: |
          BUILD_DIR=$(pwd)
          mkdir $BUILD_DIR/dist

          cd qemu
          mkdir build
          cd build
          
          ../configure --target-list=aarch64-softmmu --without-default-features --enable-kvm --static --prefix=$BUILD_DIR/dist
          ninja
          ninja install

      - name: Archive binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-linux-arm64
          path: |
            dist

  build_windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - uses: msys2/setup-msys2@v2

      - name: Install packages
        shell: msys2 {0}
        run: |
          pacman --noconfirm -S base-devel mingw-w64-x86_64-toolchain git python ninja
          pacman --noconfirm -S mingw-w64-x86_64-glib2 mingw-w64-x86_64-pixman python-setuptools

      - name: Download QEMU
        shell: msys2 {0}
        run: |
          wget https://download.qemu.org/qemu-$QEMU_VERSION.tar.xz
          tar -xf qemu-$QEMU_VERSION.tar.xz
          mv qemu-$QEMU_VERSION qemu

      - name: Build QEMU
        shell: msys2 {0}
        run: |
          $BUILD_DIR=$(pwd)
          mkdir $BUILD_DIR\dist

          cd qemu
          mkdir build
          cd build
          
          ../configure --target-list=x86_64-softmmu --without-default-features --enable-whpx --prefix=$BUILD_DIR\dist
          ninja
          ninja install

      - name: Archive binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-windows-amd64
          path: |
            dist